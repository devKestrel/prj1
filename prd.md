# 경마게임 PRD

## 1) 개요
- 목적: Windows 11 환경에서 실행되는 Node.js 기반의 가상 경마 게임. 10마리 말이 좌→우로 달리는 레이스를 실시간 시뮬레이션하고, 레이스 시작 전 말별 베팅(게임 내 재화) 기능 제공
- **플레이 방식**: 1인 싱글플레이. 총 4명의 참가자가 베팅/플레이하며, **플레이어 1명 + NPC 3명** 구성. NPC는 자동으로 베팅/관전, 정산에 참여
- 대상 사용자: 캐주얼 게이머, 확률형 시뮬레이션/파티 게임 관심 사용자
- 수익화: 광고/코스튬 등 코스메틱 IAP (현금성 베팅은 제외)
- 법적/윤리 기준: 실제 화폐 도박 기능은 미제공. 연령 안내/경고 문구 표기 (검증 필요)

## 2) 목표/비목표
### 목표
- 10마리 말 동시 출주, 실시간 진행 바/애니메이션으로 레이스 상황 표시
- 레이스 시작 전 베팅(게임 머니) 및 배당 산출
- 랜덤 말 이름 생성 및 즐겨찾기/차명 기능
- 결과/히스토리/유저 머니 관리
- 공정성 확보: PRNG 기반, 시드 기록/리플레이

### 비목표
- 실물 화폐 베팅/환전
- 고도 3D 그래픽, 고성능 물리엔진
- 대규모 MMO 네트워킹

## 3) 사용자 시나리오 (유저 스토리)
- U1: 유저는 앱을 실행하고 금일의 기본 게임 머니를 수령한다. ex) 1,000코인
- U2: 로비에서 다음 레이스 타이머를 확인한다. ex) 30초 후 시작
- U3: 말 리스트(10마리)와 각 말의 임시 오즈/최근 성적을 보고 원하는 말에 베팅한다. ex) 말 #7에 200코인
- U4: **NPC 3명은 베팅 마감 전 AI 로직에 따라 각자 다른 전략으로 베팅한다.** ex) 보수형/밸런스형/공격형
- U5: 레이스가 시작되면 트랙에서 말들이 좌→우로 이동하는 애니메이션을 본다.
-## 4) 핵심 기능 요구사항
### 4.1 레이스 관리
- R1: 레이스는 일정 간격(예: 60초)으로 자동 생성
- R2: 각 레이스는 10마리 말로 구성, 트랙 길이·속도·가속/감속 랜덤 변수 적용
- R3: 말의 기본 능력치(속도 범위, 스테미나, 변동성)를 레이스마다 난수로 부여
- R4: 충돌/중첩 없이 진행바/스프라이트가 자연스럽게 이동
- R5: 결승 순위, 기록(ms), 구간 랩 데이터 저장

### 4.2 베팅
- B1: 레이스 시작 N초 전까지(예: 15초) 베팅 가능, 시작 시점 베팅 마감
- B2: 말별 베팅 한도/최소 단위 설정 가능. ex) 최소 10코인
- B3: 배당 오즈는 총 베팅 금액과 말별 베팅 분포로 산출(파리뮤추얼 방식 유사)
- B4: 승식: 단승(1등 맞히기) 1종으로 시작, 추후 복승/삼복승 확장 (검증 필요)
- B5: 정산 시, 당첨자에게 배당금 분배 및 수수료(하우스 컷) 옵션 적용 (검증 필요)
- **B6: 참가자 모델** — 4명(플레이어 1, NPC 3) 모두 같은 규칙으로 베팅/정산. NPC 금액·선택은 AI 전략에 따라 결정

### 4.3 NPC AI (베팅)
- AI1: **보수형**: 최근 3전 상위 평균 순위 및 낮은 분산 말에 저액 분산 베팅
- AI2: **밸런스형**: 예상 배당×최근 지표의 기대값이 높은 말에 중액 1~2마리 집중
- AI3: **공격형**: 장외 고배당 말에 소수 고액 베팅, 변동성 높은 말 선호
- AI 공통: 베팅 마감 직전 확률 재평가(실시간 오즈 반영), 보유 코인 한도·쿨다운 적용

### 4.4 랜덤 말 이름 생성
- N1: 사전 정의 접두사·중간·접미사 조합 규칙. ex) "썬더"+"스트라이크" / "블루"+"코멧"
- N2: 중복 방지 및 금칙어 필터
- N3: 즐겨찾기/차명: 유저가 말의 표시명 별칭 설정 가능(개인 표시용)

### 4.5 공정성/투명성
- F1: PRNG(seeded)로 능력치·이벤트 결정, 레이스 시드 UI 표시
- F2: 리플레이 모드에서 동일 시드 재연 가능
- F3: 서버 로그에 시드·결과 서명 저장, 위변조 방지 해시 기록 (검증 필요)

### 4.6 UI/UX
- U1: 로비(다음 레이스 타이머, 내 코인, 최근 결과)
- U2: 베팅 화면(10마리 카드, 간단 스탯, 실시간 예상 배당, **NPC 예상 베팅 경향 힌트**)
- U3: 레이스 트랙 화면(Canvas) – 좌→우 이동 애니메이션, 미니맵/순위 표시
- U4: 결과 모달(순위, 배당, 정산), 히스토리 탭(플레이어·NPC 베팅 로그)

### 4.7 계정/진척도
- A1: 로컬 게스트 계정(초기) + 선택적 이메일 연동 (검증 필요)
- A2: 일일 보너스/연속 출석 보상
- A3: 코스튬/스킨 인벤토리(말 안장 색상, 이펙트 등 – 코스메틱)

## 5) 비기능 요구사항필요)
- A2: 일일 보너스/연속 출석 보상
- A3: 코스튬/스킨 인벤토리(말 안장 색상, 이펙트 등 – 코스메틱)

## 5) 비기능 요구사항
- 성능: 60FPS 목표(저사양 모드 30FPS), 10마리 동시 애니메이션 유지
- 안정성: 단일 레이스 실패 시 앱 크래시 없이 복구
- 보안: 클라이언트 조작 방지(정산 로직은 서버 측), 중요 데이터 무결성 체크
- 호환성: Windows 11, Node.js LTS(현재 안정판) (검증 필요)
- 접근성: 색각 보정 팔레트, 키보드 조작 지원

## 6) 시스템 아키텍처 제안
- 앱 형태: Web UI(HTML5 Canvas) + Node.js(Express) + Socket.IO 실시간 송수신
- 선택: Electron 포장으로 데스크톱 단일 실행 파일 제공 (검증 필요)
- NPC 로직: 서버 사이드 모듈로 스케줄링(베팅 마감 T-초 시점에 AI 평가→베팅)

### 구성도(개념)
- 클라이언트(React/Canvas) ⇄ Socket.IO ⇄ Node.js(게임 룸/매치메이킹/정산/NPC AI) ⇄ DB(SQLite → 향후 PostgreSQL)

## 7) 데이터 모델(초안)
| 테이블 | 필드 | 타입 | 설명 |
|---|---|---|---|
| users | id, nickname, coins, created_at | INTEGER/TEXT | 로컬/계정 사용자 |
| races | id, seed, start_at, status | INTEGER/TEXT | 레이스 메타 |
| horses | id, race_id, name, base_speed, stamina, variance | INTEGER/REAL | 말 능력치 |
| bets | id, race_id, user_id, horse_id, amount | INTEGER | 베팅 내역 |
| results | race_id, rank_json, payout_json | TEXT | 순위/배당 결과 |
| participants | id, type(player/npc), nickname, coins | INTEGER/TEXT | 참가자 프로필 |
| participant_bets | id, race_id, participant_id, horse_id, amount | INTEGER | 참가자별 베팅 |
| npc_profiles | participant_id, strategy(conservative/balanced/aggressive), risk, avg_stake | TEXT/REAL | NPC 전략 파라미터 |

## 8) API 설계(초안)
| 메소드 | 경로 | 요청 | 응답 | 설명 |
|---|---|---|---|---|
| GET | /api/races/next | - | {race} | 다음 레이스 정보 |
| POST | /api/bets | {raceId, horseId, amount} | {ok, balance} | 베팅 등록(플레이어) |
| POST | /internal/npc/bets | {raceId} | {ok, snapshot} | **서버 내부용** NPC 일괄 베팅 트리거 |
| GET | /api/odds/:raceId | - | {horseId: odds} | 실시간 예상 배당 |
| GET | /api/races/:id/state | - | {positions[],timeLeft} | 진행 상황(웹소켓 권장) |
| GET | /api/races/:id/result | - | {rank[],payouts} | 결과/배당 |
| GET | /api/history | {limit,offset} | {items[]} | 결과·베팅 히스토리 |

## 9) 레이스 로직(초안)
- 트랙 길이: 1000 단위
- tick(프레임): 16ms(60FPS)
- 말 i의 순간 속도 v_i(t) = base_speed + noise(variance) + boost 이벤트(확률)
- 스태미나에 따라 후반 감속 계수 적용
- 동점 시 소수점 자리 기록 비교
- 결승: pos_i ≥ 1000 도달 순간 시간 기록

## 10) 배당 산식(파리뮤추얼 유사, 단승)
- 총풀 T = Σ 모든 말 베팅액(플레이어 + NPC)
- 하우스 컷 c 적용 시 유효풀 U = T × (1−c)
- 당첨 말에 베팅된 금액 W
- 배당률 odds = U / W
- 수익 = floor(베팅액 × odds)
- c 기본값 10%(설정 가능) (검증 필요)
- **밸런싱 파라미터(예시)**
| 항목 | 기본값 | 범위 | 설명 |
|---|---|---|---|
| NPC 평균 베팅액 | 80 | 30~200 | 참가자당 평균 베팅 |
| NPC 공격성 | 0.5 | 0.0~1.0 | 고배당 선호 정도 |
| 하우스 컷 c | 0.10 | 0.00~0.20 | 운영 수수료 |
| 최소 베팅 | 10 | 10~100 | 단위 금액 |

## 11) 랜덤 이름 규칙(예시)
- 사전: [썬더, 블레이즈, 블루, 크림슨, 루나, 스톰, 코멧, 스피릿, 퀘이크, 제트]
- 조합: 2~3개 파츠 랜덤 결합, 발음 부딪힘 방지 룰 적용
- ex) "블루 코멧", "크림슨 스톰", "루나 제트"

## 12) UI 와이어프레임(텍스트)
- 로비: 타이머 + 다음 레이스 미리보기 + 내 코인 + **참가자 리스트(플레이어/NPC3)**
- 베팅: 10마리 카드(이름, 예상 배당, 최근 3전 성적), 금액 입력, 총합 표시, **NPC 베팅 로그(간략)**
- 레이스: Canvas 트랙, 각 말 스프라이트/아이콘, 실시간 순위, 미니맵, 해설 텍스트(옵션)
- 결과: 순위표, 배당, 정산, 리플레이 버튼, **참가자별 손익 정리 테이블**

## 13) 설정/운영
- 레이스 간격(초), 베팅 마감(초), 말 능력치 범위, 하우스 컷, 최소/최대 베팅, 일일 보너스
- 로그: 시드/결과/정산 해시, 비정상 행위 탐지

## 14) 테스트/수용 기준(샘플)
- T1: 10마리 표시 및 이동이 끊김 없이 60FPS에 근접
- T2: 베팅 마감 이후 POST /api/bets 거부
- T3: 동일 시드로 레이스 재생 시 동일 결과 재현
- T4: 총 베팅 1000, 당첨말 베팅 250, c=10% → 배당률 900/250=3.6, 100코인 베팅 수익=360코인
- T5: 비정상 패킷/속도 조작 시 서버 무시
- **T6: NPC 3명 베팅이 전략에 따라 통계적으로 상이한 분포(공격형은 고배당 선택 비율↑)로 나타남**
- **T7: 플레이어가 베팅하지 않아도 NPC만으로 오즈가 변동하며 UI에 실시간 반영**

## 15) 추정 일정/마일스톤
| 주차 | 항목 | 산출물 |
|---|---|---|
| 1주차 | 프로토타입(싱글 로컬) | Canvas 레이스, 단순 난수 진행 |
| 2주차 | 베팅/배당 로직 | 베팅 UI, 정산 API |
| 3주차 | 실시간/웹소켓 | 실시간 포지션 업데이트 |
| 4주차 | 히스토리/리플레이 | 결과 저장, 시드 재생 |
| 5주차 | 폴리싱/QA | 접근성, 성능, 예외 처리 |

## 16) 리스크/대응
- 확률 공정성 논란 → 시드 공개/검증 가능한 로그 제공
- 과몰입/중독 우려 → 일일 한도/쿨다운 옵션, 경고 문구
- 성능 이슈 → 스프라이트 단순화, 오프스크린 캔버스, 요청 샘플링

## 17) 기술 스택(제안)
- Node.js(Express), Socket.IO, SQLite(개발) / PostgreSQL(운영), React + Canvas
- 빌드/패키징: Electron(선택), pnpm, esbuild/Vite (검증 필요)

## 18) 오픈 이슈
- 연령 등급/표기 가이드라인 지역별 요건 (검증 필요)
- 하우스 컷·세부 승식 룰의 지역 규제 적합성 (검증 필요)
- Electron 패키징 용량/자동업데이트 도입 여부 (검증 필요)

## 19) 부록: 샘플 난수 시뮬 로직(의사코드)
```
seed = initSeed()
for horse in horses:
  horse.base = randRange(3.0, 6.0)
  horse.stamina = randRange(0.8, 1.2)
  horse.var = randRange(-0.5, 0.5)
while max(pos) < TRACK_LEN:
  for horse in horses:
    v = horse.base + noise(horse.var) + boostIf(horse.stamina)
    pos[horse] += max(0, v) * dt
```

## 20) 용어
- 단승: 1등 맞히기 승식
- 파리뮤추얼: 총풀을 당첨자끼리 나눠 갖는 배당 방식

